<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="authors" content="Zhengyuan Zhu">
  <title>IDIR COVID19</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/leaflet.css" />
  <link rel="stylesheet" href="css/MarkerCluster.Default.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">
  <link href="https://fonts.googleapis.com/css?family=Titillium+Web|Oswald" rel="stylesheet">
  <link href="css/c3.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/simplebar.css" />
  <link rel="stylesheet" href="css/main.css">
  <link href="css/bootstrap4-toggle.min.css" rel="stylesheet">
  <link rel="icon" href="img/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="css/leaflet.awesome-markers.css">
  <link rel="stylesheet" href="http://code.ionicframework.com/ionicons/1.5.2/css/ionicons.min.css">
  <script src="js/d3.js"></script>
  <script src="js/c3.min.js"></script>
  <script src="js/leaflet.js"></script>
  <script src="js/leaflet.markercluster.js"></script>
  <script src="js/leaflet-polygon.fillPattern.js"></script>
  <script src="js/topojson.v1.min.js"></script>
  <script src="js/chroma.min.js"></script>
  <script src="js/jquery-3.3.1.min.js"></script>
  <script type="text/javascript" src="js/jquery.sparkline.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/bootstrap4-toggle.min.js"></script>
  <script src="js/simplebar.min.js"></script>
  <script src="js/leaflet.awesome-markers.js"></script>
</head>

<body>
  <main>
    <!-- <div class="loader"></div> -->
    <div id="info" data-simplebar data-simplebar-auto-hide="true">
      <div id="title" style="font-size:30px;text-align: center;background-color: rgb(79, 105, 120);color: rgb(232, 235, 238)">COVID19 Pandemic - Public Information</div>
      <p style="background-color: rgb(40, 50, 55); text-align: center;"><span id="placename" style="color: rgb(197, 207, 212)">GLOBAL TREND</span> </p>
      <div id="deck-1" class="card-deck counts">
        <div class="card">
          <div class="card-body confirmed">
            <h5 class="card-title">Aggregated Confirmed</h5>
          </div>
          <p class="card-text">
            <span class="confirmed-count"></span><span class="confirmed-new-count">
            </span>
          </p>
        </div>
        <div class="card">
          <div class="card-body active">
            <h5 class="card-title">Active Confirmed</h5>
          </div>
          <p class="card-text">
            <span class="active-count"></span>
            <span class="active-new-count"></span>
            <i id="counticon" class="nav fas fa-exclamation-circle tooltip counticon active-new-count-tooltip"></i>
          </p>
        </div>
      </div>
      <div id="deck-2" class="card-deck counts">
        <div class="card">
          <div class="card-body recovered">
            <h5 class="card-title">Recovered</h5>
            <p class="card-text"><span class="recovered-count"></span><span class="recovered-new-count"></span></p>
          </div>
        </div>

        <div class="card">
          <div class="card-body death">
            <h5 class="card-title">Death</h5>
            <p class="card-text"><span class="death-count"></span><span class="death-new-count"></span></p>
          </div>
        </div>
      </div>

      <div id="timeline-chart"></div>
      <div id="total-chart"></div>
      <div id="rank-chart"></div>

    </div> 
    <div id="table">
      <div id="table-container" data-simplebar data-simplebar-auto-hide="true">
        <table id="table-container-div" class="table table-bordered">
          <thead>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>



    </div>

    <div id="legend-panel" class="card-deck legend">

      <div class="card">
        <div class="card-body">
          <h5 class="card-title grey-circles" style="color:black">no case</h5>
        </div>
      </div>

      <div class="card">
        <div class="card-body legend-color-1">
          <h5 class="card-title" style="color:black">1</h5>
        </div>
      </div>

      <div class="card">
        <div class="card-body legend-color-2">
          <h5 class="card-title" style="color:black">10</h5>

        </div>
      </div>
      <div class="card">
        <div class="card-body  legend-color-3">
          <h5 class="card-title" style="color:black">100</h5>

        </div>
      </div>

      <div class="card">
        <div class="card-body  legend-color-4">
          <h5 class="card-title" style="color:black">250</h5>

        </div>
      </div>

      <div class="card">
        <div class="card-body legend-color-5">
          <h5 class="card-title" style="color:black">1,000</h5>
        </div>
      </div>

      <div class="card">
        <div class="card-body legend-color-6">
          <h5 class="card-title" style="color:black">10,000+</h5>
        </div>
      </div>
    </div>
    <div id="map"></div>


  </main>
  <div id="infowindow" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document" style="width:1250px!important">
      <div class="modal-content">
        <div class="modal-header">
          <strong class="modal-title" id="exampleModalLongTitle">Info</strong>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <script src="js/main.js"></script>
  <script>
    var mymap = L.map('map', {
      zoomControl: false,
      zoom: 0,
      maxZoom: 10,
      minZoom: 0,
      worldCopyJump: true,
    }).fitWorld().setView([37, -107], 5)
    new L.Control.Zoom({
      position: 'bottomright'
    }).addTo(mymap);

    L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{ maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']
}).addTo(mymap);;



    var chart, rchart;

    var colors = chroma.scale('YlOrRd').mode('lch').colors(6);
    for (i = 0; i < 6; i++) {
      $('head').append($("<style> .region-color-" + (i + 1).toString() + " { color: " + colors[i] + "; font-size: 15px; text-shadow: 0 0 3px #ffffff;} </style>"));
      $('head').append($("<style> .legend-color-" + (i + 1).toString() + " { background: " + colors[i] + "; font-size: 15px; text-shadow: 0 0 3px #ffffff;} </style>"));
    }


    var communities = new L.MarkerClusterGroup({
      spiderfyOnMaxZoom: false,
      singleMarkerMode: true,
      // showCoverageOnHover: false,
      // zoomToBoundsOnClick: false,
      iconCreateFunction: function(cluster) {
        return L.divIcon({
          // html: '<i class="fas fa-procedures community community-marker"> <b>' + cluster.getChildCount() + '</b></i>'
          html: '<i class="fas fa-procedures community community-marker"> <b>' + cluster.getChildCount() + '</b></i>'
        });
      }

    });

    var cases = new L.MarkerClusterGroup({
      spiderfyOnMaxZoom: true,
      singleMarkerMode: true,
      polygonOptions: {
        fillColor: "black",
        color: 'black',
        weight: 0.5,
        opacity: 0.6,
        fillOpacity: 0.2
      },
      showCoverageOnHover: true,
      // zoomToBoundsOnClick: false,
      iconCreateFunction: function(cluster) {
        cnt = cluster.getChildCount()
        return L.divIcon({
            html: '<i class="fas fa-map-marker community community-marker fa-3x" ><br><span style="text-align: center; margin: 0px; width: 30px; position: absolute; left: -2px; top: 5px;font-size:12px; color:white">'+cnt+'</span></i>',
          });
      }
    }).addTo(mymap);


    Promise.all([
      d3.csv('assets/virus.csv'),
      d3.json("assets/all-topo-15.json"),
      d3.csv('assets/communities.csv'),
      d3.csv('assets/timestamp.txt'),
      d3.csv('assets/cases.csv'),
      d3.csv('assets/united-states.txt'),
      d3.csv('assets/canada-city.txt'),
      d3.csv('assets/old-name.csv')
    ]).then(function(datasets) {

      $("#date").text("Last update: " + datasets[3][0].timestamp.split(".")[0] + " PST");

      datasets[2].forEach(function(d) {
        L.marker([parseFloat(d.lat), parseFloat(d.lng)]).bindPopup(d.name + "&nbsp;&nbsp;(<a target='_blank' href='https://translate.google.com/#view=home&op=translate&sl=zh-CN&tl=en&text=" + d.name + "'>Translate to English</a>)").addTo(
          communities);
      })


      datasets[4].forEach(function(d) {
        //console.log(d.id)
        L.marker([parseFloat(d.lat), parseFloat(d.lng)]).bindPopup("<b>" + d.no + "</b> <p>" + d.note + " identified on " + d.date + ", &nbsp;" + d.reference + ".</p>").addTo(
          cases);
      })



      var latest = datasets[0][datasets[0].length - 1];
      //delete latest["datetime"];


      var top = {},
        ustop = {},
        cntop = {};
      top["china"] = 0;
      Object.keys(latest).forEach(function(d) {
        // value = tc(datasets[0][datasets[0].length - 1][d]) - tr(datasets[0][datasets[0].length - 1][d]) - td(datasets[0][datasets[0].length - 1][d]);
        value = tc(datasets[0][datasets[0].length - 1][d]);
        if (datasets[7]["columns"].includes(d)) {
          // console.log(value);
          // console.log(top["china"]);
          top["china"] += +value;
          cntop[d] = value;

        } else if (datasets[6]["columns"].includes(d)) {
          ;
        } else if (datasets[5]["columns"].includes(d)) {
          ustop[d] = value;
        } else if(d != "datetime"){
          top[d] = value;
        }

      })


      function sortJsObject(obj) {
        items = Object.keys(obj).map(function(key) {
          return [key, obj[key]];
        });
        items.sort(function(first, second) {
          return second[1] - first[1];
        });
        sorted_obj = {}
        $.each(items, function(k, v) {
          use_key = v[0]
          use_value = v[1]
          sorted_obj[use_key] = use_value
        })
        return (sorted_obj)
      }


      stop = sortJsObject(top);
      sustop = sortJsObject(ustop);


      var places = {};

      function calPlace(name) {
        var place = {}
        place[name] = {
          't': ['t'],
          'c': ['Aggr. Confirmed'],
          's': ['s'],
          'r': ['Recovered'],
          'd': ['Death'],
          'a': ['Active Confirmed']
        }
        datasets[0].forEach(function(d) {
          var USTd = new Date(d["datetime"]);

          place[name].t.push(USTd.setHours(USTd.getHours() + 8));

          cf = 0, sp = 0, rc = 0, dd = 0, active = 0;
          current = d;
          delete current["datetime"];

          if (name == "Global Trend") {

            Object.values(current).forEach(function(d) {
              if (d == undefined) {
                d = "0"
              };
              items = d.split("-");
              switch (items.length) {
                case 4:
                  dd += +items[3];
                case 3:
                  rc += +items[2];
                case 2:
                  sp += +items[1];
                case 1:
                  cf += +items[0];
                  break;
              };
              active = cf - dd - rc;
            });

            cf -= (tc(current["alabama"]) + tc(current["alaska"]) + tc(current["arizona"]) + tc(current["arkansas"]) + tc(current["california"]) + tc(current["colorado"]) + tc(current["connecticut"]) + tc(current["delaware"]) + tc(current[
                "florida"]) + tc(current["georgia usa"]) + tc(current["hawaii"]) + tc(current["idaho"]) + tc(current["illinois"]) + tc(current["indiana"]) + tc(current["iowa"]) + tc(current["kansas"]) + tc(current["kentucky"]) + tc(current[
                "louisiana"]) + tc(current["maine"]) + tc(current["maryland"]) + tc(current["massachusetts"]) + tc(current["michigan"]) + tc(current["minnesota"]) + tc(current["mississippi"]) + tc(current["missouri"]) + tc(current[
                "montana"]) + tc(
                current["nebraska"]) + tc(current["nevada"]) + tc(current["new hampshire"]) + tc(current["new jersey"]) + tc(current["new mexico"]) + tc(current["new york"]) + tc(current["north carolina"]) + tc(current["north dakota"]) +
              tc(current[
                "ohio"]) + tc(current["oklahoma"]) + tc(current["oregon"]) + tc(current["pennsylvania"]) + tc(current["rhode island"]) + tc(current["south carolina"]) + tc(current["south dakota"]) + tc(current["tennessee"]) + tc(current[
                "texas"]) +
              tc(current["utah"]) + tc(current["vermont"]) + tc(current["virginia"]) + tc(current["washington"]) + tc(current["west virginia"]) + tc(current["canada"]));

            rc -= (tr(current["alabama"]) + tr(current["alaska"]) + tr(current["arizona"]) + tr(current["arkansas"]) + tr(current["california"]) + tr(current["colorado"]) + tr(current["connecticut"]) + tr(current["delaware"]) + tr(current[
                "florida"]) + tr(current["georgia usa"]) + tr(current["hawaii"]) + tr(current["idaho"]) + tr(current["illinois"]) + tr(current["indiana"]) + tr(current["iowa"]) + tr(current["kansas"]) + tr(current["kentucky"]) + tr(current[
                "louisiana"]) + tr(current["maine"]) + tr(current["maryland"]) + tr(current["massachusetts"]) + tr(current["michigan"]) + tr(current["minnesota"]) + tr(current["mississippi"]) + tr(current["missouri"]) + tr(current[
                "montana"]) + tc(
                current["nebraska"]) + tr(current["nevada"]) + tr(current["new hampshire"]) + tr(current["new jersey"]) + tr(current["new mexico"]) + tr(current["new york"]) + tr(current["north carolina"]) + tr(current["north dakota"]) +
              tr(current[
                "ohio"]) + tr(current["oklahoma"]) + tr(current["oregon"]) + tr(current["pennsylvania"]) + tr(current["rhode island"]) + tr(current["south carolina"]) + tr(current["south dakota"]) + tr(current["tennessee"]) + tr(current[
                "texas"]) +
              tr(current["utah"]) + tr(current["vermont"]) + tr(current["virginia"]) + tr(current["washington"]) + tr(current["west virginia"]) + tr(current["canada"]));

            dd -= (td(current["alabama"]) + td(current["alaska"]) + td(current["arizona"]) + td(current["arkansas"]) + td(current["california"]) + td(current["colorado"]) + td(current["connecticut"]) + td(current["delaware"]) + td(current[
                "florida"]) + td(current["georgia usa"]) + td(current["hawaii"]) + td(current["idaho"]) + td(current["illinois"]) + td(current["indiana"]) + td(current["iowa"]) + td(current["kansas"]) + td(current["kentucky"]) + td(current[
                "louisiana"]) + td(current["maine"]) + td(current["maryland"]) + td(current["massachusetts"]) + td(current["michigan"]) + td(current["minnesota"]) + td(current["mississippi"]) + td(current["missouri"]) + td(current[
                "montana"]) + tc(
                current["nebraska"]) + td(current["nevada"]) + td(current["new hampshire"]) + td(current["new jersey"]) + td(current["new mexico"]) + td(current["new york"]) + td(current["north carolina"]) + td(current["north dakota"]) +
              td(current[
                "ohio"]) + td(current["oklahoma"]) + td(current["oregon"]) + td(current["pennsylvania"]) + td(current["rhode island"]) + td(current["south carolina"]) + td(current["south dakota"]) + td(current["tennessee"]) + td(current[
                "texas"]) +
              td(current["utah"]) + td(current["vermont"]) + td(current["virginia"]) + td(current["washington"]) + td(current["west virginia"]) + td(current["canada"]));

          } else if (name == "china") {


            for (const [key, value] of Object.entries(current)) {

              if (key == "anhui" || key == "beijing" || key == "chongqing" || key == "fujian" || key == "gansu" || key == "guangdong" ||
                key == "guangxi" || key == "guizhou" || key == "hainan" || key == "hebei" || key == "heilongjiang" || key == "henan" || key == "hongkong" ||
                key == "hubei" || key == "hunan" || key == "neimenggu" || key == "jiangsu" || key == "jiangxi" || key == "jilin" || key == "liaoning" ||
                key == "macau" || key == "ningxia" || key == "qinghai" || key == "shaanxi" || key == "shandong" || key == "shanghai" || key == "shanxi" ||
                key == "sichuan" || key == "taiwan" || key == "tianjin" || key == "xinjiang" || key == "yunnan" || key == "zhejiang" || key == "xizang") {

                if (value == undefined) {
                  value = "0"
                };
                items = value.split("-");
                switch (items.length) {
                  case 4:
                    dd += +items[3];
                  case 3:
                    rc += +items[2];
                  case 2:
                    sp += +items[1];
                  case 1:
                    cf += +items[0];
                    break;
                };
                active = cf - dd - rc;
              }
            }


          } else {


            d = current[name];
            if (d == undefined) {
              d = "0"
            };
            items = d.split("-");
            switch (items.length) {
              case 4:
                dd += +items[3];
              case 3:
                rc += +items[2];
              case 2:
                sp += +items[1];
              case 1:
                cf += +items[0];
                break;
            };
            active = cf - dd - rc;

          }
          active = cf - dd - rc;
          place[name].c.push(cf);
          //place[name].s.push(sp);
          place[name].r.push(rc);
          place[name].d.push(dd);
          place[name].a.push(active);

        });

        return place[name];
      }

      function showPlace(name) {

        len = places[name].t.length;
        $(".confirmed-count").text(places[name].c[len - 1]);
        $(".recovered-count").text(places[name].r[len - 1]);
        $(".death-count").text(places[name].d[len - 1]);
        $(".active-count").text(places[name].a[len - 1]);

        nc = places[name].c[len - 1] - places[name].c[len - 2];
        nr = places[name].r[len - 1] - places[name].r[len - 2];
        nd = places[name].d[len - 1] - places[name].d[len - 2];
        na = places[name].a[len - 1] - places[name].a[len - 2];

        if (nc > 0) {
          $(".confirmed-new-count").text("+" + nc.toString());
        } else if (nc == 0) {
          $(".confirmed-new-count").text("");
        } else {

          $(".confirmed-new-count").text(nc.toString());
        }

        if (nr > 0) {
          $(".recovered-new-count").text("+" + nr.toString());
        } else if (nr == 0) {
          $(".recovered-new-count").text("")
        } else {
          $(".recovered-new-count").text(nr.toString());
        }
        if (nd > 0) {
          $(".death-new-count").text("+" + nd.toString());
        } else if (nd == 0) {
          $(".death-new-count").text("")
        } else {
          $(".death-new-count").text(nd.toString());
        }


        if (na > 0) {
          document.getElementById("counticon").style.display = "initial";
          $(".active-new-count").text("+" + na.toString());
        } else if (na < 0) {
          document.getElementById("counticon").style.display = "initial";
          $(".active-new-count").text("" + na.toString());
        } else if (na == 0) {
          document.getElementById("counticon").style.display = "none";
          $(".active-new-count").text("")
        } else {
          document.getElementById("counticon").style.display = "none";
          $(".active-new-count").text(na.toString());
        }


        if (name == "anhui" || name == "beijing" || name == "chongqing" || name == "fujian" || name == "gansu" || name == "guangdong" ||
          name == "guangxi" || name == "guizhou" || name == "hainan" || name == "hebei" || name == "heilongjiang" || name == "henan" ||
          name == "hubei" || name == "hunan" || name == "neimenggu" || name == "jiangsu" || name == "jiangxi" || name == "jilin" || name == "liaoning" ||
          name == "ningxia" || name == "qinghai" || name == "shaanxi" || name == "shandong" || name == "shanghai" || name == "shanxi" ||
          name == "sichuan" || name == "tianjin" || name == "xinjiang" || name == "yunnan" || name == "zhejiang" || name == "xizang") {
          $("#placename").text(name.toUpperCase() + ", CHINA");
        } else {
          $("#placename").text(name.toUpperCase());
        }

      }


      function setFill(enname) {
        var pop = datasets[0][datasets[0].length - 1][enname];
        if (pop == "" || pop == undefined || pop.toString().split("-")[0] == "0") {
          return 'url(img/texture-s.png)'; //non-case country, 0 aggregate confirm
        } else {
          pop = +pop.toString().split("-")[0] - +pop.toString().split("-")[2] - +pop.toString().split("-")[3]; // remaining confirmed
          // return "#00000000";
        }
        if (pop == 0) {
          return 'url(img/texture-sg.png)'; // 0 active confirm
          // return 'url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMCcgaGVpZ2h0PScxMCc+CiAgPHJlY3Qgd2lkdGg9JzEwJyBoZWlnaHQ9JzEwJyBmaWxsPSd3aGl0ZScgLz4KICA8cmVjdCB4PScwJyB5PScwJyB3aWR0aD0nMScgaGVpZ2h0PScxJyBmaWxsPSdibGFjaycgLz4KPC9zdmc+")';
        } else {
          return 'url()';
        }


      }

      function setColor(enname) {
        var id = 0;
        var pop = datasets[0][datasets[0].length - 1][enname];

        if (pop != undefined) {
          pop = +pop.toString().split("-")[0] - +pop.toString().split("-")[2] - +pop.toString().split("-")[3]; // remaining confirmed
        } else {
          pop = 0;
          // return "#00000000";
        }

        if (pop >= 10000) {
          id = 5;
        } else if (pop > 1000 && pop <= 10000) {
          id = 4;
        } else if (pop > 250 && pop <= 1000) {
          id = 3;
        } else if (pop > 100 && pop <= 250) {
          id = 2;
        } else if (pop > 10 && pop <= 100) {
          id = 1;
        } else if (pop > 0 && pop <= 10) {
          id = 0;
        } else {
          id = -1;
          return "#00000000";
        }
        return colors[id];
      }


      function style(feature) {
        if (feature.properties.enname == "us" || feature.properties.enname == "canada") {
          return {
            fillColor: '#dc3545',
            fillOpacity: 0,
            opacity: 0,
          };
        } else {
          return {
            fill: setFill(feature.properties.enname),
            fillColor: setColor(feature.properties.enname),
            fillOpacity: 0.4,
            weight: 0.5,
            opacity: 1,
            color: '#b4b4b4',
            dashArray: '2'
          };
        }
      }



      function highlightFeature(e) {
        // e indicates the current event
        var layer = e.target; //the target capture the object which the event associates with
        layer.setStyle({
          weight: 2,
          opacity: 0.8,
          color: '#DC143C',
          fillColor: '#00ffd9',
          fillOpacity: 0.1
        });
        // bring the layer to the front.
        
        layer.bringToFront();
        if (e.target.feature.properties.enname == "us" || e.target.feature.properties.enname == "canada") {
          layer.bringToBack();
        }
      }

      // 3.2.2 zoom to the highlighted feature when the mouse is clicking onto it.
      function zoomToFeature(e) {
        // mymap.fitBounds(e.target.getBounds());

        L.DomEvent.stopPropagation(e);
        $("#hint").text("Click here to the global trend.");
        displayPlace(e.target.feature.properties.enname)
      }

      // 3.2.3 reset the hightlighted feature when the mouse is out of its region.
      function resetHighlight(e) {
        areas.resetStyle(e.target);
      }

      // 3.3 add these event the layer obejct.
      function onEachFeature(feature, layer) {
        layer.on({
          mouseover: highlightFeature,
          click: zoomToFeature,
          mouseout: resetHighlight
        });
      }

      var areas = new L.TopoJSON(datasets[1], {
        style: style,
        onEachFeature: onEachFeature
      }).addTo(mymap);



      $("#hint").on("click", function() {
        places["Global Trend"] = calPlace("Global Trend");
        showPlace("Global Trend");
        // calCounts(global);
        chart.load({
          columns: [places["Global Trend"].c, places["Global Trend"].a, places["Global Trend"].r, places["Global Trend"].d],
          unload: ['Aggr. Confirmed', 'Active Confirmed', 'Recovered', 'Death'],
        });

        $("#hint").text("Click a place to review local trend.");

      });

      mymap.on('click', onMapClick);


      function onMapClick(e) {
        $("#hint").click();
      }


      places["Global Trend"] = calPlace("Global Trend");
      showPlace("Global Trend");


      chart = c3.generate({
        size: {
          height: 280,
          width: 460
        },
        data: {
          x: "t",
          y: "confirmed",
          columns: [places["Global Trend"].t, places["Global Trend"].c, places["Global Trend"].a, places["Global Trend"].r, places["Global Trend"].d],
          type: 'line',
          axes: {
            confirmed: 'y'
          },
          colors: {
            'Aggr. Confirmed': '#dc3545',
            // Suspected: 'orange',
            'Active Confirmed': 'orange',
            Recovered: '#28a745',
            Death: '#5d4f72e8'
          }
        },
        zoom: {
          enabled: true
        },
        axis: {
          x: {
            type: "timeseries",
            tick: {
              format: "%b %d",
              centered: true,
              fit: true,
              count: 8
            }
          },
          y: {
            label: {
              text: 'Cases',
              position: 'outer-middle'
            },
            min: 0,
            padding: {
              bottom: 0
            },
            type: 'linear'
          }
        },
        point: {
          r: 3,
          focus: {
            expand: {
              r: 5
            }
          }
        },
        zoom: {
          // rescale: true,
          enabled: false,
          type: "scroll",
        },
        tooltip: {
          linked: true,
        },
        legend: {
          position: 'inset',
          inset: {
            anchor: "top-left",
            y: 10
          },
        },
        bindto: "#total-chart"
      });


      function displayPlace(name) {

        places[name] = calPlace(name);
        showPlace(name);

        chart.load({
          columns: [places[name].c, places[name].a, places[name].r, places[name].d],
          unload: ['Aggr. Confirmed', 'Active Confirmed', 'Recovered', 'Death'],
        });

      }


      function makeTable() {

        var topinuse = {};
        if (document.getElementById('areaSwitcher').checked != false) {
          topinuse = sustop;
        } else {
          topinuse = stop;
        }

        Object.keys(topinuse).slice(0, 51).forEach(function(d) {
          if (d.toUpperCase() == "DIAMOND PRINCESS") {
            return;
          }
          var dlabel = d.toUpperCase();
          if (d.toUpperCase() == "GEORGIA USA") {
            dlabel = "GEORGIA";
          }
          $("tbody").append("<tr id='" + d.replace(" ", "") + "-row'><th style='text-align:right;cursor: pointer;'>" + dlabel + "</th></tr>");
          places[d] = calPlace(d);





          $("tr#" + d.replace(" ", "") + "-row").append('<th ><i class="cell-' + d.replace(" ", "") + '">' + "" + '</i></th>');


          var a = [];
          for (var i = len - showLen; i < len; i++) {
            a.push(places[d].a[i]);
          }

          $("." + 'cell-' + d.replace(" ", "")).sparkline(a, {
            type: 'line',
            lineColor: '#bf0000',
            fillColor: '#ffd4aa',
            disableTooltips: true
          });


          for (var i = len - showLen; i < len; i++) {
            // a.push(places[d].a[i]);
            //$("tr#" + d.replace(" ", "") + "-row").append('<th scope="col"><i class="cell">' + places[d].c[i] + '</i></th>');
            $("tr#" + d.replace(" ", "") + "-row").append('<th ><i class="cell cell-' + d.replace(" ", "") + '-' + i.toString() + '">' + "" + '</i></th>');
            bgcolor = "#28a745";
            bdcolor = "#28a745";
            size = "32px";
            bdsize = "0px";
            top = "0rem";
            left = "0rem";


            //all the cases are recovered
            // c ===> 0, 10, 100, 1000, 10000
            // size =>0,  4,   8,   16,    32

            if (places[d].c[i] >= 10000) {
              size = "32px"
              top = "-.45rem";
              left = "-.35rem";


            } else if (places[d].c[i] < 10000 && places[d].c[i] >= 1000) {
              size = "24px";
              top = "-.2rem";
              left = "-.1rem";

            } else if (places[d].c[i] < 1000 && places[d].c[i] >= 100) {
              size = "16px";
              top = "0rem";
              left = ".1rem";;


            } else if (places[d].c[i] < 100 && places[d].c[i] >= 10) {
              size = "10px";
              top = ".25rem";
              left = ".25rem";

            } else if (places[d].c[i] < 10 && places[d].c[i] >= 1) {
              size = "8px";
              top = ".25rem";
              left = ".25rem";
            } else {
              size = "0px";
              bdsize = "0px";
            }


            // a/c rate ==> red, oregen, yellow, green{plus yellow}
            // color ==>  recover:  #28a745
            // a ===>
            acrate = places[d].a[i] / places[d].c[i]

            colors = chroma.scale('YlOrRd').mode('lch').colors(6);
            if (acrate > 0.995) {
              bgcolor = colors[5];
            } else if (acrate >= 0.9 && acrate <= 0.995) {
              bgcolor = colors[4];
            } else if (acrate >= 0.5 && acrate <= 0.9) {
              bgcolor = colors[3];
            } else if (acrate >= 0.3 && acrate <= 0.5) {
              bgcolor = colors[2];
            } else {
              bgcolor = colors[1];
            }


            $('.cell-' + d.replace(" ", "") + '-' + i.toString())
              .css("background-color", bgcolor)
              .css("border", bdsize + " solid " + bdcolor)
              .css("width", size)
              .css("height", size)
              .css("margin-top", top)
              .css("margin-left", left);


          }




          $("tr#" + d.replace(" ", "") + "-row").on("click", function() {
            // places[d] = calPlace(d);
            showPlace(d);

            chart.load({
              columns: [places[d].c, places[d].a, places[d].r, places[d].d],
              unload: ['Aggr. Confirmed', 'Active Confirmed', 'Recovered', 'Death'],
            });
          })



        })

      }


      $('#areaSwitcher').change(function() {

        $('.loader').show();

        $("#rankingToggle").css('visibility', 'visible');

        $("#table").css("visibility", "visible");
        $(".leaflet-control-container").css("visibility", "hidden");


        len = places["Global Trend"].t.length
        showLen = 25
        $("thead").html('<th scope="col" style="text-align:right; width:120px !important"><b>Country</b></th>');
        $("thead").append("<th style='text-align:center' >Active Confirmed</th>");

        Object.values(places["Global Trend"].t.slice(len - 1 - showLen, len - 1)).forEach(function(d) {
          //label = new Date(new Date(d).setHours(new Date(d).getHours() + 8)).toString().substring(4,10);
          label = (new Date(d)).toString().substring(4, 10);
          // console.log(label);
          $("thead").append("<th style='text-align:center' >" + label + "</th>");
        });


        $("tbody").html('');
        makeTable();


        $('.loader').fadeOut("slow");

      })


      $('#panelSwitcher').change(function() {
        $('.loader').show();

        if (document.getElementById('panelSwitcher').checked == false) {
          $("#table").css("visibility", "hidden");
            $("#rankingToggle").css("visibility", "hidden");
          $(".leaflet-control-container").css("visibility", "visible");

          $("thead").html('');
          $("tbody").html('');


        } else {

          $("#rankingToggle").css('visibility', 'visible');

          $("#table").css("visibility", "visible");
          $(".leaflet-control-container").css("visibility", "hidden");


          len = places["Global Trend"].t.length
          showLen = 20
          $("thead").html('<th scope="col" style="text-align:right; width:120px !important"><b>Country</b></th>');
          $("thead").append("<th style='text-align:center' >Active Confirmed</th>");

          Object.values(places["Global Trend"].t.slice(len - 1 - showLen, len - 1)).forEach(function(d) {
            //label = new Date(new Date(d).setHours(new Date(d).getHours() + 8)).toString().substring(4,10);
            label = (new Date(d)).toString().substring(4, 10);
            // console.log(label);
            $("thead").append("<th style='text-align:center' >" + label + "</th>");
          });


          $("tbody").html('');


          makeTable();


        }
        $('.loader').fadeOut("slow");

      })

      $(".leaflet-control-attribution")
        .css("background-color", "transparent")
        .html("");



    });
  </script>

  <!-- Google Analytics -->
  <script>
    window.ga = window.ga || function() {
      (ga.q = ga.q || []).push(arguments)
    };
    ga.l = +new Date;
    ga('create', 'UA-100818948-4', 'auto');
    ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>

  <script>
    window.ga = window.ga || function() {
      (ga.q = ga.q || []).push(arguments)
    };
    ga.l = +new Date;
    ga('create', 'UA-159947082-1', 'auto');
    ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  <!-- Google Analytics End-->
</body>

</html>